{# apps/business/templates/business/showcase/business_edit.html #}

{% extends "users/base_userpanel.html" %}
{% load static %}

{% block users_content %}
<div class="container" style="margin-top:2rem; margin-bottom:2rem;">
    <h2 class="col-12 d-flex justify-center my-3">{{ business.title }}</h2>
    <h3>{{ form.instance.pk|yesno:"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞,–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞" }}</h3>

    <div style="border:1px solid #ccc; border-radius:8px; padding:1rem;">

        {# ===== –§–∞–≤–∏–∫–æ–Ω ===== #}
        <fieldset style="margin-top: 1rem;">
          <legend>–§–∞–≤–∏–∫–æ–Ω</legend>
          <div class="row mb-4">
              <div class="col-6 col-sm-12">
                {% if business.favicon and business.favicon.url %}
                  <img id="favicon_preview" src="{{ business.favicon.url }}" alt="–§–∞–≤–∏–∫–æ–Ω" style="width: 64px; height:64px; display: block;">
                {% else %}
                  <img id="favicon_preview" src="{% static 'business/images/placeholder.jpg' %}" alt="–§–∞–≤–∏–∫–æ–Ω" style="width:64px; height:64px;">
                {% endif %}
              </div>
              <div class="col-6 col-sm-12">
                <form id="favicon_upload_form" enctype="multipart/form-data" method="post"
                      data-upload-url="{% url 'business:upload_favicon' business_slug=business.slug %}"
                      data-delete-url="{% url 'business:delete_favicon' business_slug=business.slug %}">
                  {% csrf_token %}
                  <input type="file" name="favicon" id="id_favicon_file" hidden>
                  <button type="button" id="select_favicon_btn" class="btn btn--large btn--success">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–≤–∏–∫–æ–Ω</button>
                  <button type="button" id="delete_favicon_btn" class="btn btn--compact btn--danger">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
              </div>
          </div>
        </fieldset>

        {# ===== –õ–æ–≥–æ—Ç–∏–ø ===== #}
        <fieldset style="margin-top: 1rem;">
          <legend>–õ–æ–≥–æ—Ç–∏–ø</legend>
          <div class="row mb-4">
              <div class="col-6 col-sm-12">
                {% if business.logo and business.logo.url %}
                  <img id="logo_preview" src="{{ business.logo.url }}" alt="–õ–æ–≥–æ—Ç–∏–ø" style="max-width: 128px; max-height: 128px; display: block;">
                {% else %}
                  <img id="logo_preview" src="{% static 'business/images/placeholder.jpg' %}" alt="–õ–æ–≥–æ—Ç–∏–ø" style="max-width:128px; max-height:128px;">
                {% endif %}
              </div>
              <div class="col-6 col-sm-12">
                <form id="logo_upload_form" enctype="multipart/form-data" method="post"
                      data-upload-url="{% url 'business:upload_logo' business_slug=business.slug %}"
                      data-delete-url="{% url 'business:delete_logo' business_slug=business.slug %}">
                  {% csrf_token %}
                  <input type="file" name="logo" id="id_logo_file" hidden>
                  <button type="button" id="select_logo_btn" class="btn btn--large btn--success">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</button>
                  <button type="button" id="delete_logo_btn" class="btn btn--compact btn--danger">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
              </div>
          </div>
        </fieldset>

        {# ===== –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ –±–∏–∑–Ω–µ—Å–∞ ===== #}
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% for field in form %}
                {% if field.name not in "logo favicon" %}
                    <div style="margin-bottom:1rem;">
                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
                        <div>{{ field }}</div>
                        {% for error in field.errors %}
                            <div style="color:red;">{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endfor %}
            <div style="margin-bottom:1rem;">
                <button type="submit" class="btn btn--large btn--success">
                    {{ form.instance.pk|yesno:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è,–°–æ–∑–¥–∞—Ç—å –±–∏–∑–Ω–µ—Å" }}
                </button>
                <a href="{% url 'business:business_list' %}" class="btn btn--secondary">–û—Ç–º–µ–Ω–∞</a>
            </div>
        </form>

        {# ===== –ë–ª–æ–∫ –¢–æ–≤–∞—Ä—ã ===== #}
        <fieldset style="margin-top:2rem;">
          <legend>–¢–æ–≤–∞—Ä—ã</legend>
          <div style="display:flex; flex-wrap:wrap; gap:0.5rem;">
              {% for goods in business.goodss.all %}
              <div style="border:1px solid #ccc; border-radius:6px; padding:0.5rem; width:120px; text-align:center;">
                  {% if goods.image %}
                  <img src="{{ goods.image.url }}" alt="{{ goods.title }}" style="width:100%; height:80px; object-fit:cover; border-radius:4px;">
                  {% else %}
                  <div style="width:100%; height:80px; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:4px;">
                      {{ goods.title|slice:":1" }}
                  </div>
                  {% endif %}
                  <div style="margin-top:0.25rem; font-size:0.85rem;">{{ goods.title }}</div>
                  <a href="{% url 'business:goods_edit' business.slug goods.slug %}" class="btn btn--compact btn--secondary">‚úèÔ∏è</a>

                  <form id="delete-goods-{{ goods.slug }}"
                          method="post"
                          action="{% url 'business:goods_delete' business.slug goods.slug %}">
                      {% csrf_token %}
                      <button type="button"
                              onclick="confirmDeleteItem('goods', '{{ goods.slug }}', '{{ goods.title }}')"
                              title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä"
                              style="background:none; border:none; color:red; cursor:pointer;">
                          üóë
                      </button>
                  </form>

              </div>
              {% empty %}
              <p>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>
              {% endfor %}
          </div>
          <div style="margin-top:0.5rem;">
              <a href="{% url 'business:goods_create' business_slug=business.slug %}" class="btn btn--success btn--compact">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</a>
          </div>
        </fieldset>

        {# ===== –ë–ª–æ–∫ –£—Å–ª—É–≥–∏ ===== #}
        <fieldset style="margin-top:2rem;">
          <legend>–£—Å–ª—É–≥–∏</legend>
          <div style="display:flex; flex-wrap:wrap; gap:0.5rem;">
              {% for service in business.services.all %}
              <div style="border:1px solid #ccc; border-radius:6px; padding:0.5rem; width:120px; text-align:center;">
                  {% if service.image %}
                  <img src="{{ service.image.url }}" alt="{{ service.title }}" style="width:100%; height:80px; object-fit:cover; border-radius:4px;">
                  {% else %}
                  <div style="width:100%; height:80px; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:4px;">
                      {{ service.title|slice:":1" }}
                  </div>
                  {% endif %}
                  <div style="margin-top:0.25rem; font-size:0.85rem;">{{ service.title }}</div>
                  <a href="{% url 'business:service_edit' business.slug service.slug %}" class="btn btn--compact btn--secondary">‚úèÔ∏è</a>

                  <form id="delete-service-{{ service.slug }}"
                      method="post"
                      action="{% url 'business:service_delete' business.slug service.slug %}">
                      {% csrf_token %}
                      <button type="button"
                              onclick="confirmDeleteItem('service', '{{ service.slug }}', '{{ service.title }}')"
                              title="–£–¥–∞–ª–∏—Ç—å —É—Å–ª—É–≥—É"
                              style="background:none; border:none; color:red; cursor:pointer;">
                          üóë
                      </button>
                  </form>


              </div>
              {% empty %}
              <p>–ù–µ—Ç —É—Å–ª—É–≥</p>
              {% endfor %}
          </div>
          <div style="margin-top:0.5rem;">
              <a href="{% url 'business:service_create' business_slug=business.slug %}" class="btn btn--success btn--compact">+ –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</a>
          </div>
        </fieldset>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const STATIC_URL = "{% get_static_prefix %}";
</script>
<script src="{% static 'business/js/business_upload.js' %}"></script>
<script src="{% static 'core/js/libs/sweetalert2.all.min.js' %}"></script>
<script>
function confirmDeleteItem(type, slug, title) {
    let formId = 'delete-' + type + '-' + slug;

    Swal.fire({
        title: '–í—ã —É–≤–µ—Ä–µ–Ω—ã?',
        text: `–í—ã —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${type === 'product' ? '—Ç–æ–≤–∞—Ä' : '—É—Å–ª—É–≥—É'} "${title}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '–î–∞',
        cancelButtonText: '–ù–µ—Ç',
        reverseButtons: true,
        focusCancel: true,
        background: '#f0f0f0',
        color: '#333',
        iconColor: '#ff0000',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#dc3545',
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById(formId).submit();
        }
    });
}
</script>
{% endblock %}
