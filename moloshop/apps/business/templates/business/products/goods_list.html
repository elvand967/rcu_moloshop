
{# apps/business/templates/business/products/goods_list.html #}

{% extends "users/base_userpanel.html" %}
{% load static %}
{% load core_extras %}

{% block extra_head %}
<link type="text/css" href="{% static 'business/css/business.css' %}" rel="stylesheet" />
{{ block.super }}
{% endblock %}

{% block users_content %}
<h2 class="page-title">–¢–æ–≤–∞—Ä—ã –±–∏–∑–Ω–µ—Å–∞ {{ business.title }}</h2>

<a href="{% url 'business:goods_create' business.slug %}" class="btn btn-primary" style="margin-bottom:1rem;">
  ‚ûï –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä
</a>

<div class="accordion" style="max-width: 800px; margin: 2rem auto; border-radius:.75rem; overflow: hidden;">
  {% for goods in goodss %}
    <div class="accordion-item" data-goods-id="{{ goods.id }}" style="border-bottom: 1px solid #ddd;">
      <div class="accordion-header products-accordion-header">
        <div class="products-thumb">
          {% if goods.image %}
            <img src="{{ goods.image.url }}" alt="{{ goods.title }}" class="products-thumb-img">
          {% else %}
            <div class="products-no-thumb">üíá</div>
          {% endif %}
        </div>

        <div class="products-info">
          <span class="products-title">{{ goods.title }}</span>
          <span class="products-price">{{ goods.price }} {{ goods.currency }}</span>
          <div class="products-duration">
            {% if goods.duration %}
              ‚è± {{ goods.duration_display }}
            {% endif %}
          </div>
        </div>

        <img
          src="{% static 'core/img/icons/png/chevron-left.png' %}"
          alt="Toggle"
          class="toggle-icon products-toggle-icon"
        />
      </div>

      <div class="accordion-body" style="max-height: 0; overflow: hidden; background:#fff; transition: max-height 0.3s ease, padding 0.3s ease; padding-top: 0; padding-bottom: 0;">

      {# –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–æ–∂–∫–∏ —Ç–æ–≤–∞—Ä–∞ #}
      <fieldset style="margin: .75rem 1rem;">
        <legend>–û–±–ª–æ–∂–∫–∞ —Ç–æ–≤–∞—Ä–∞</legend>
        <div class="row mb-4">
          <div class="col-6 col-sm-12">
            {% if goods.image %}
              <img class="goods-image-preview"
                   src="{{ goods.image.url }}"
                   alt="–û–±–ª–æ–∂–∫–∞ —Ç–æ–≤–∞—Ä–∞"
                   style="border-radius:.75rem; display:block;">

            {% else %}
              <img class="goods-image-preview"
                   src="{% static 'business/images/placeholder.jpg' %}"
                   alt="–û–±–ª–æ–∂–∫–∞ —Ç–æ–≤–∞—Ä–∞"
                   style="border-radius:.75rem; display:block;">
            {% endif %}
          </div>

          <div class="col-6 col-sm-12">
            <form class="goods-image-upload-form"
                  enctype="multipart/form-data"
                  method="post"
                  data-upload-url="{% url 'business:upload_goods_image' business_slug=business.slug goods_slug=goods.slug %}"
                  data-delete-url="{% url 'business:delete_goods_image' business_slug=business.slug goods_slug=goods.slug %}">
              {% csrf_token %}
              <input type="file" name="image" class="goods-image-file" hidden>
              <button type="button" class="btn btn--large btn--success select-goods-image-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É</button>
              <button type="button" class="btn btn--compact btn--danger delete-goods-image-btn">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          </div>
        </div>
      </fieldset>

      {# –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ #}
      <fieldset style="margin: .75rem 1rem;">
        <legend>–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É—Å–ª—É–≥</legend>
        <div id="gallery_preview_{{ goods.slug }}"
             data-business-slug="{{ business.slug }}"
             data-model-type="goods"
             data-model-slug="{{ goods.slug }}"
             class="gallery-preview">
          {% with gallery=gallery_dict|get_item:goods.id %}
            {% if gallery %}
              {% for media in gallery %}
                <div class="gallery-item" id="gallery-item-{{ media.id }}">
                  <a href="{{ media.file.url }}" target="_blank" rel="noopener noreferrer" title="–û—Ç–∫—Ä—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ">
                    <img src="{{ media.file.url }}" alt="{{ media.alt_text }}" class="gallery-img">
                  </a>
                  <button type="button"
                          class="btn btn-sm btn-danger btn-delete-image"
                          data-media-id="{{ media.id }}"
                          title="–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                    ‚úï
                  </button>
                </div>
              {% endfor %}
            {% else %}
              <p>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
            {% endif %}
          {% endwith %}
        </div>

        <form id="gallery_upload_form_{{ goods.slug }}" enctype="multipart/form-data" method="post"
              data-upload-url="{% url 'business:upload_gallery_image' business_slug=business.slug model_type='goods' model_slug=goods.slug %}">
          {% csrf_token %}
          <input type="file" id="id_gallery_image_file_{{ goods.slug }}" name="image" hidden>
          <button type="button" id="select_gallery_image_btn_{{ goods.slug }}" class="btn btn--large btn--success" style="margin-top:1rem;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
        </form>
      </fieldset>

      {# –§–æ—Ä–º–∞ —Ç–æ–≤–∞—Ä–∞ #}
      <form method="post" class="goods-form p-3" style="display:flex; flex-direction:column; gap:0.5rem;">
        {% csrf_token %}
        <input type="hidden" name="goods_id" value="{{ goods.id }}">
          {% with form=goods_forms|get_item:goods.id %}
            {% for field in form %}
              {% include "core/partials/field_row.html" with field=field %}
            {% endfor %}
          {% endwith %}
        <button type="submit" class="btn-save" style="margin-top: 0.5rem; background: #4CAF50; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: background 0.3s;">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        </form>

        <form id="delete-goods-{{ goods.slug }}" method="post" action="{% url 'business:goods_delete' business.slug goods.slug %}" style="margin-top: 0.5rem;">
          {% csrf_token %}
          <button
            type="button"
            class="btn-delete"
            onclick="confirmDeleteItem('goods', '{{ goods.slug }}', '{{ goods.title }}')"
            style="background: #dc3545; color: #fff; border: none; margin: 0 .75rem; padding: 0.4rem 1rem; border-radius:.75rem; cursor: pointer; transition: background 0.3s;">
            üóë –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
          </button>
        </form>

      </div>
    </div>
  {% empty %}
    <p>–ü–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.</p>
  {% endfor %}
</div>

{# –ü–∞–≥–∏–Ω–∞—Ç–æ—Ä #}
{% if goodss.has_other_pages %}
<nav class="pagination-wrapper" style="text-align:center; margin:2rem 0;">
  <ul class="pagination" style="display:inline-flex; flex-wrap:wrap; gap:0.5rem; justify-content:center; list-style:none; padding:0;">

    {# –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" #}
    {% if goodss.has_previous %}
      <li>
        <a class="page-link" href="?page={{ goodss.previous_page_number }}{% if active_goods_id %}&active_goods_id={{ active_goods_id }}{% endif %}"
           aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
           style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:.5rem;">
          ‚Üê
        </a>
      </li>
    {% else %}
      <li><span class="page-link disabled" style="padding:0.5rem 1rem; color:#999;">‚Üê</span></li>
    {% endif %}

    {# –ù–æ–º–µ—Ä –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã #}
    {% if goodss.number > 3 %}
      <li>
        <a class="page-link" href="?page=1{% if active_goods_id %}&active_goods_id={{ active_goods_id }}{% endif %}"
           style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:.5rem;">1</a>
      </li>
      {% if goodss.number > 4 %}
        <li><span style="padding:0.5rem 0.75rem;">‚Ä¶</span></li>
      {% endif %}
    {% endif %}

    {# –î–∏–∞–ø–∞–∑–æ–Ω —Ç–µ–∫—É—â–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (—Ç–µ–∫—É—â–∞—è ¬±2) #}
    {% for num in goodss.paginator.page_range %}
      {% if num >= goodss.number|add:"-2" and num <= goodss.number|add:"2" %}
        {% if num == goodss.number %}
          <li><span class="page-link active"
                    style="padding:0.5rem 1rem; background:#4CAF50; color:#fff; border-radius:.5rem;">{{ num }}</span></li>
        {% else %}
          <li>
            <a class="page-link" href="?page={{ num }}{% if active_goods_id %}&active_goods_id={{ active_goods_id }}{% endif %}"
               style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:.5rem;">{{ num }}</a>
          </li>
        {% endif %}
      {% endif %}
    {% endfor %}

    {# –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏ –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ #}
    {% if goodss.number < goodss.paginator.num_pages|add:"-2" %}
      {% if goodss.number < goodss.paginator.num_pages|add:"-3" %}
        <li><span style="padding:0.5rem 0.75rem;">‚Ä¶</span></li>
      {% endif %}
      <li>
        <a class="page-link" href="?page={{ goodss.paginator.num_pages }}{% if active_goods_id %}&active_goods_id={{ active_goods_id }}{% endif %}"
           style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:.5rem;">{{ goodss.paginator.num_pages }}</a>
      </li>
    {% endif %}

    {# –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä—ë–¥" #}
    {% if goodss.has_next %}
      <li>
        <a class="page-link" href="?page={{ goodss.next_page_number }}{% if active_goods_id %}&active_goods_id={{ active_goods_id }}{% endif %}"
           aria-label="–°–ª–µ–¥—É—é—â–∞—è"
           style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:.5rem;">
          ‚Üí
        </a>
      </li>
    {% else %}
      <li><span class="page-link disabled" style="padding:0.5rem 1rem; color:#999;">‚Üí</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function() {
  const headers = document.querySelectorAll(".accordion-header");

  headers.forEach(header => {
    header.addEventListener("click", (event) => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è (–∏–ª–∏ –¥—Ä—É–≥–æ–º—É –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É),
      // —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ —Ç—É–¥–∞
      if (event.target.closest(".btn-delete") || event.target.closest(".btn-delete-image") || event.target.closest("button")) {
        return;
      }

      const isActive = header.classList.contains("active");
      const body = header.nextElementSibling;

      if (isActive) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫
        header.classList.remove("active");
        header.querySelector(".toggle-icon").classList.remove("active");
        body.style.maxHeight = null;
        body.style.paddingTop = "0";
        body.style.paddingBottom = "0";
      } else {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
        headers.forEach(h => {
          h.classList.remove("active");
          h.querySelector(".toggle-icon").classList.remove("active");
          const b = h.nextElementSibling;
          b.style.maxHeight = null;
          b.style.paddingTop = "0";
          b.style.paddingBottom = "0";
        });
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
        header.classList.add("active");
        header.querySelector(".toggle-icon").classList.add("active");
        body.style.maxHeight = (body.scrollHeight + 20) + "px";
        body.style.paddingTop = "1rem";
        body.style.paddingBottom = "1rem";
      }
    });
  });

  {% if active_goods_id %}
  const activeItem = document.querySelector(`.accordion-item[data-goods-id="{{ active_goods_id }}"]`);
  if(activeItem){
    const activeHeader = activeItem.querySelector(".accordion-header");
    const activeBody = activeHeader.nextElementSibling;
    activeHeader.classList.add("active");
    activeHeader.querySelector(".toggle-icon").classList.add("active");
    activeBody.style.maxHeight = (activeBody.scrollHeight + 20) + "px";
    activeBody.style.paddingTop = "1rem";
    activeBody.style.paddingBottom = "1rem";
  }
  {% endif %}
});
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'business/js/goodss_upload.js' %}"></script>
<script src="{% static 'business/js/gallery_upload_and_delete.js' %}"></script>
<script src="{% static 'core/js/libs/sweetalert2.all.min.js' %}"></script>
<script src="{% static 'business/js/confirm_delete.js' %}"></script>
{% endblock %}