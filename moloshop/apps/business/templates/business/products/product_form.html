
{# apps/business/templates/business/products/product_form.html #}

{% extends "users/base_userpanel.html" %}
{% load static %}

{% block users_content %}
<div class="container mt-4">
  <h2>
    {% if product %}Редактирование товара{% else %}Создание товара{% endif %}
  </h2>

  {# Загрузка обложки товара #}
  <fieldset style="margin-top: 1rem;">
    <legend>Обложка</legend>
    <div class="row mb-4">
      <div class="col-6 col-sm-12">
        {% if product.image %}
          <img id="product_image_preview" src="{{ product.image.url }}" alt="Обложка" style="max-width: 128px; max-height: 128px; display: block;">
        {% else %}
          <img id="product_image_preview" src="{% static 'business/images/placeholder.jpg' %}" alt="Обложка" style="max-width: 128px; max-height: 128px;">
        {% endif %}
      </div>
      <div class="col-6 col-sm-12">
        <form id="product_image_upload_form" enctype="multipart/form-data" method="post"
              data-upload-url="{% url 'business:upload_product_image' business_slug=business.slug product_slug=product.slug %}"
              data-delete-url="{% url 'business:delete_product_image' business_slug=business.slug product_slug=product.slug %}">
          {% csrf_token %}
          <input type="file" name="image" id="id_product_image_file" hidden>
          <button type="button" id="select_product_image_btn" class="btn btn--large btn--success">Загрузить обложку</button>
          <button type="button" id="delete_product_image_btn" class="btn btn--compact btn--danger">Удалить</button>
        </form>
      </div>
    </div>
  </fieldset>

  {# Товар #}
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}

    {% for field in form %}
      <div class="mb-3">
        {{ field.label_tag }}
        {{ field }}
        {% if field.help_text %}
          <div class="form-text">{{ field.help_text }}</div>
        {% endif %}
        {% for error in field.errors %}
          <div class="text-danger">{{ error }}</div>
        {% endfor %}
      </div>
    {% endfor %}

    <button type="submit" class="btn btn--success">
      {% if product %}Сохранить изменения{% else %}Создать товар{% endif %}
    </button>
    <a href="{% url 'business:business_edit' business.slug %}" class="btn btn--danger">Отмена</a>
  </form>


{# Галерея изображений товара #}
<fieldset style="margin-top: 2rem;">
  <legend>Галерея изображений товара</legend>
  <div id="gallery_preview_{{ product.slug }}"
     data-business-slug="{{ business.slug }}"
     data-model-slug="{{ product.slug }}"
     data-model-type="product"
     class="gallery-preview">
  {% if gallery %}
    {% for media in gallery %}
    <div class="gallery-item" id="gallery-item-{{ media.id }}">
      <img src="{{ media.file.url }}" alt="{{ media.alt_text }}" class="gallery-img">
      <button type="button"
              class="btn btn-sm btn-danger btn-delete-image"
              data-media-id="{{ media.id }}">
        Удалить
      </button>
    </div>
    {% endfor %}
  {% else %}
    <p>Изображения отсутствуют.</p>
  {% endif %}
</div>


  <form id="gallery_upload_form_{{ product.slug }}" enctype="multipart/form-data" method="post"
        data-upload-url="{% url 'business:upload_gallery_image' business_slug=business.slug model_type='product' model_slug=product.slug %}">
    {% csrf_token %}
    <input type="file" id="id_gallery_image_file_{{ product.slug }}" name="image" hidden>
    <button type="button" id="select_gallery_image_btn_{{ product.slug }}" class="btn btn--large btn--success" style="margin-top:1rem;">Загрузить изображение</button>
  </form>
</fieldset>


<style>
.gallery-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}
.gallery-item {
  position: relative;
  display: inline-block;
  border: 1px solid #ccc;
  padding: 4px;
  max-width: 120px;
}
.gallery-img {
  display: block;
  max-width: 100%;
  max-height: 100px;
  object-fit: cover;
}
.gallery-item .btn-delete-image {
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.7rem;
  padding: 2px 6px;
  line-height: 1;
  cursor: pointer;
}
</style>



</div>
{% endblock %}

{% block extra_js %}
<script>
    const STATIC_URL = "{% get_static_prefix %}";
</script>

<script src="{% static 'business/js/business_upload.js' %}"></script>

<script src="{% static 'business/js/delete_gallery_image.js' %}"></script>

{% endblock %}